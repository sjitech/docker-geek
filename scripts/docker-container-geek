#!/bin/bash
set -o errexit -o pipefail

function show_usage() {
  >&2 echo "Start a docker-geek in which mount a container to /rootfs."
  >&2 echo ""
  >&2 echo "Usage:"
  >&2 echo "  ${0##*/} [OPTIONS] CONTAINER_ID_OR_NAME [COMMAND [ARGS...]]"
  >&2 echo ""
  >&2 echo "OPTIONS:"
  >&2 echo "  -i, --interactive                    Keep STDIN open even if not attached"
  >&2 echo "  -t, --tty                            Allocate a pseudo-TTY"
  >&2 echo ""
  >&2 echo "Note:"
  >&2 echo "  - If no any argument specified, it will run an interactive /bin/bash (implies '-i' and '-t')."
  >&2 echo "  - You can pass extra docker run option via env var DOCKER_GEEK_OPTION"
  >&2 echo ""
  exit 1
}

OPT_INTERACTIVE=""; OPT_TTY=""

while [[ $# > 0 ]]; do
  case $1 in
  -i|--interactive)
    OPT_INTERACTIVE=$1
    ;;
  -t|--tty)
    OPT_TTY=$1
    ;;
  -*)
    [[ ! $1 =~ ^-[it]+$ ]] && show_usage
    [[ $1 == *i* ]] && OPT_INTERACTIVE=-i
    [[ $1 == *t* ]] && OPT_TTY=-t
    ;;
  *)
    break
    ;;
  esac
  shift
done

ID=${1:?${0##*/}: require next argument as an id or name of an container}; shift

if [[ $# == 0 && ! $OPT_INTERACTIVE && ! $OPT_TTY ]]; then
  OPT_INTERACTIVE=-i
  OPT_TTY=-t
fi

PID=$(docker-pid-of-container "$ID")

ROOTFS=$(docker-rootfs-of-container "$ID")

[[ ! $ID =~ ^[0-9a-f]{12}$ && ! $ID =~ ^[0-9a-f]{64}$ ]] && ID=$(docker container inspect -f '{{.ID}}' "$ID")

# Notes:
# - The --add-host GEEK:127.0.0.1 is for avoiding sudo from warning about host can not be resolved.
# - The /rootfs/etc/resolv.conf /rootfs/etc/hostname /rootfs/etc/hosts will be empty files.
#   To also see above files, use docker-container-geek-ns which enter network namespace of target container.

export DOCKER_GEEK_NETWORK_NS="--network=host --hostname=GEEK-${ID:0:12} --add-host GEEK-${ID:0:12}:127.0.0.1"
export DOCKER_GEEK_OPTION="$DOCKER_GEEK_OPTION -v $ROOTFS:/rootfs --workdir=/rootfs"
exec docker-geek $OPT_INTERACTIVE $OPT_TTY "$@"
